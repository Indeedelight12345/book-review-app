---
- name: Clone backend source
  git:
    repo: "https://github.com/pravinmishraaws/book-review-app.git"
    dest: /home/ubuntu/book-review-app/backend
    version: main

- name: Install Node.js 18
  shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  args:
    warn: false

- name: Install Node and build tools
  apt:
    name:
      - nodejs
      - build-essential
      - mysql-client
    state: present
    update_cache: yes

- name: Install PM2
  npm:
    name: pm2
    global: yes

- name: Clone backend repo
  git:
    repo: "{{ backend_repo_url}}"
    dest: "{{ backend_dir }}"
    version: main

- name: Create backend .env file
  copy:
    dest: "{{ backend_dir }}/.env"
    content: |
      PORT={{ backend_port }}
      DB_HOST={{ db_host }}
      DB_NAME={{ db_name }}
      DB_USER={{ db_user }}
      DB_PASS={{ db_pass }}
      DB_DIALECT=mysql
      DB_PORT=3306
      JWT_SECRET={{ jwt_secret }}
      ALLOWED_ORIGINS={{ allowed_origins }}

- name: Install backend dependencies
  command: npm install
  args:
    chdir: "{{ backend_dir }}"

- name: Start backend
  command: pm2 start npm --name "backend-app" -- run dev
  args:
    chdir: "{{ backend_dir }}"
